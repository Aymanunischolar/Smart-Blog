<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Smart Blog</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Base Admin Styles */
        .admin-body { background: #09090b; color: #e4e4e7; font-family: sans-serif; padding: 20px; }
        .stat-card h2 { color: #529ecc; margin: 0; }

        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #18181b; padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .tab-btn { background: none; border: none; color: #777; padding: 10px 20px; cursor: pointer; font-size: 1rem; }
        .tab-btn.active { color: #529ecc; border-bottom: 2px solid #529ecc; }

        /* Section Visibility */
        .admin-section { display: none; background: #18181b; padding: 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); animation: fadeIn 0.3s ease; }
        .admin-section.active { display: block; }

        /* Tables */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th { text-align: left; color: #777; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .data-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* Buttons */
        .btn-action { padding: 6px 12px; border-radius: 6px; cursor: pointer; border: none; font-size: 0.8rem; margin-right: 5px; color: white; }
        .btn-restore { background: #22c55e; }
        .btn-del { background: #ef4444; }
        .btn-ban { background: #f59e0b; color: #000; font-weight: bold; }
        .btn-view { background: #529ecc; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background-color: #18181b; margin: 5% auto; padding: 30px; border: 1px solid #333; width: 80%; max-width: 700px; border-radius: 12px; color: #fff; max-height: 80vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: white; }

        /* Preview Content Styles */
        .preview-img { width: 100%; height: auto; border-radius: 8px; margin-bottom: 15px; display: none; }
        .preview-body { line-height: 1.6; color: #d1d5db; margin-top: 15px; font-size: 1rem; }
        .preview-hashtags { margin-top: 20px; color: #529ecc; font-size: 0.9rem; }
        .meta-info { margin-top: 20px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.85rem; color: #aaa; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="admin-body">
    <div class="container">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <div style="font-size:1.5rem; font-weight:bold;"><i class="fa-solid fa-shield-halved"></i> ADMIN PORTAL</div>
            <a href="/" style="color:#aaa; text-decoration:none;"><i class="fa-solid fa-arrow-left"></i> Back to Blog</a>
        </header>

        <div class="admin-grid" id="statsGrid">
            <div class="stat-card"><h2>-</h2><p>Total Posts</p></div>
            <div class="stat-card"><h2>-</h2><p>Total Views</p></div>
            <div class="stat-card"><h2>-</h2><p>Reports</p></div>
            <div class="stat-card"><h2>-</h2><p>Banned IPs</p></div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('moderation')">Moderation Queue</button>
            <button class="tab-btn" onclick="switchTab('posts')">All Posts</button>
            <button class="tab-btn" onclick="switchTab('banned')">Banned IPs</button>
        </div>

        <div id="sec-moderation" class="admin-section active">
            <h3><i class="fa-solid fa-flag"></i> Content Moderation Queue</h3>
            <p style="color:#888; font-size:0.9rem;">Posts flagged by AI or reaching 3+ community reports.</p>
            <table class="data-table">
                <thead><tr><th>Title</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="flaggedTable"></tbody>
            </table>
        </div>

        <div id="sec-posts" class="admin-section">
            <h3><i class="fa-solid fa-layer-group"></i> Manage All Posts</h3>
            <p style="color:#888; font-size:0.9rem;">Recent 50 posts. Delete spam or ban abusive authors.</p>
            <table class="data-table">
                <thead><tr><th>Date</th><th>Title</th><th>Author IP</th><th>Actions</th></tr></thead>
                <tbody id="allPostsTable"></tbody>
            </table>
        </div>

        <div id="sec-banned" class="admin-section">
            <h3><i class="fa-solid fa-ban"></i> Banned IPs</h3>
            <p style="color:#888; font-size:0.9rem;">Users blocked from posting for 24 hours.</p>
            <table class="data-table">
                <thead><tr><th>IP Address</th><th>Reason</th><th>Date Blocked</th><th>Action</th></tr></thead>
                <tbody id="bannedTable"></tbody>
            </table>
        </div>
    </div>

    <div id="previewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePreview()">&times;</span>
            <h2 id="prev-title" style="margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">Post Title</h2>
            <img id="prev-img" class="preview-img" src="" alt="Post Image">
            <div id="prev-body" class="preview-body"></div>
            <div id="prev-tags" class="preview-hashtags"></div>

            <div class="meta-info">
                <strong>Author IP:</strong> <span id="prev-ip" style="color:#f59e0b; font-family:monospace;"></span> <br>
                <strong>Date Posted:</strong> <span id="prev-date"></span>
            </div>

            <div style="margin-top:20px; border-top:1px solid #333; padding-top:15px; display:flex; gap:10px;">
                <button id="modal-btn-restore" class="btn-action btn-restore" style="font-size:1rem; padding:10px 20px;">Safe - Restore</button>
                <button id="modal-btn-delete" class="btn-action btn-del" style="font-size:1rem; padding:10px 20px;">Unsafe - Delete</button>
                <button id="modal-btn-ban" class="btn-action btn-ban" style="font-size:1rem; padding:10px 20px; margin-left:auto;">Ban User (24h)</button>
            </div>
        </div>
    </div>

    <script>
        // Store loaded posts globally to access them for preview
        let flaggedPostsCache = {};

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadFlagged();
            loadAllPosts();
            loadBannedIPs();
        });

        // --- TABS LOGIC ---
        function switchTab(tabName) {
            document.querySelectorAll('.admin-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(`sec-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }

        // --- DATA LOADERS ---
        async function loadStats() {
            const res = await fetch('/api/admin/stats');
            const data = await res.json();
            const cards = document.getElementById('statsGrid').children;
            cards[0].querySelector('h2').innerText = data.total_posts;
            cards[1].querySelector('h2').innerText = data.total_views;
            cards[2].querySelector('h2').innerText = data.total_reports;
            cards[3].querySelector('h2').innerText = data.blocked_ips;
        }

        async function loadFlagged() {
            const res = await fetch('/api/admin/flagged');
            const posts = await res.json();
            const tbody = document.getElementById('flaggedTable');
            tbody.innerHTML = posts.length ? '' : '<tr><td colspan="3" style="text-align:center; color:#555;">No flagged posts.</td></tr>';

            flaggedPostsCache = {}; // Reset cache

            posts.forEach(p => {
                flaggedPostsCache[p.id] = p; // Store post data for preview
                tbody.innerHTML += `
                    <tr>
                        <td>${p.title}</td>
                        <td style="color:#f59e0b; font-weight:bold;">${p.status.toUpperCase()}</td>
                        <td>
                            <button class="btn-action btn-view" onclick="openPreview(${p.id})">Preview</button>
                            <button class="btn-action btn-restore" onclick="moderate(${p.id}, 'active')">Restore</button>
                            <button class="btn-action btn-del" onclick="moderate(${p.id}, 'deleted')">Delete</button>
                        </td>
                    </tr>`;
            });
        }

        async function loadAllPosts() {
            const res = await fetch('/api/admin/posts');
            const posts = await res.json();
            const tbody = document.getElementById('allPostsTable');
            tbody.innerHTML = '';

            posts.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td>${p.date.split(' ')[0]}</td>
                        <td>${p.title} <span style="font-size:0.7rem; color:#555;">(${p.status})</span></td>
                        <td>${p.author_ip}</td>
                        <td>
                            <button class="btn-action btn-del" onclick="moderate(${p.id}, 'hard_delete')">Delete</button>
                            <button class="btn-action btn-ban" onclick="banUser('${p.author_ip}')">Ban IP</button>
                        </td>
                    </tr>`;
            });
        }

        async function loadBannedIPs() {
            const res = await fetch('/api/admin/banned');
            const ips = await res.json();
            const tbody = document.getElementById('bannedTable');
            tbody.innerHTML = ips.length ? '' : '<tr><td colspan="4" style="text-align:center; color:#555;">No banned users.</td></tr>';

            ips.forEach(i => {
                tbody.innerHTML += `
                    <tr>
                        <td>${i.ip_address}</td>
                        <td>${i.reason}</td>
                        <td>${i.blocked_at}</td>
                        <td>
                            <button class="btn-action btn-restore" onclick="unblockUser('${i.ip_address}')">Unblock</button>
                        </td>
                    </tr>`;
            });
        }

        // --- PREVIEW LOGIC ---
        function openPreview(postId) {
            const post = flaggedPostsCache[postId];
            if (!post) return;

            // Fill Modal Data
            document.getElementById('prev-title').innerText = post.title;
            document.getElementById('prev-body').innerHTML = post.content; // Render HTML
            document.getElementById('prev-tags').innerText = post.hashtags || "";
            document.getElementById('prev-ip').innerText = post.author_ip || "Unknown";
            document.getElementById('prev-date').innerText = post.date;

            // Handle Image
            const img = document.getElementById('prev-img');
            if (post.image_url) {
                img.src = post.image_url;
                img.style.display = 'block';
            } else {
                img.style.display = 'none';
            }

            // Bind buttons
            document.getElementById('modal-btn-restore').onclick = () => moderate(post.id, 'active');
            document.getElementById('modal-btn-delete').onclick = () => moderate(post.id, 'deleted');

            // BIND THE NEW BAN BUTTON
            document.getElementById('modal-btn-ban').onclick = () => banUser(post.author_ip);

            // Show Modal
            document.getElementById('previewModal').style.display = "block";
        }

        function closePreview() {
            document.getElementById('previewModal').style.display = "none";
        }

        // Close modal if clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('previewModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // --- ACTIONS ---
        async function moderate(id, status) {
            if(!confirm(`Set status to: ${status}?`)) return;
            await fetch('/api/admin/moderate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ post_id: id, status: status })
            });
            location.reload();
        }

        async function banUser(ip) {
            if (!ip || ip === 'Unknown') {
                alert("Cannot ban: IP address is unknown.");
                return;
            }
            const reason = prompt("Enter ban reason:", "Violating Community Guidelines (24h Ban)");
            if (!reason) return;

            await fetch('/api/admin/ban', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ip: ip, reason: reason })
            });
            alert(`IP ${ip} has been banned.`);
            location.reload();
        }

        async function unblockUser(ip) {
            if(!confirm(`Unblock IP ${ip}?`)) return;
            await fetch('/api/admin/unblock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ip_address: ip })
            });
            location.reload();
        }
    </script>
</body>
</html>